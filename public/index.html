<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Список пользователей</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>

<body>
    <h2>Список пользователей</h2>
    <form name="userForm">
        <input type="hidden" name="id" value="0" />
        <div class="form-group">
            <label for="name">Имя:</label>
            <input class="form-control" name="name" />
        </div>
        <div class="form-group">
            <label for="age">Возраст:</label>
            <input class="form-control" name="age" />
        </div>
        <div class="panel-body">
            <button type="submit" id="save" class="btn btn-sm btn-primary">Сохранить</button>
            <a id="reset" class="btn btn-sm btn-primary">Сбросить</a>
        </div>
    </form>
    <table class="table table-condensed table-striped table-bordered">
        <thead>
            <tr>
                <th>Id</th>
                <th>Имя</th>
                <th>возраст</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script>

        let form = document.forms['userForm'];

        let table = document.querySelector('table');

        function reserForm() {
            form.age.value = "";
            form.name.value = "";


        }

        function GetUsers() {
            $.ajax({
                url: "/api/users",
                type: "GET",
                contentType: "application/json",
                success: function (users) {
                    var rows = "";
                    $.each(users, function (index, user) {
                        // добавляем полученные элементы в таблицу
                        rows += row(user);
                    })
                    $("table tbody").append(rows);
                 }
            });
        }
        
        function getUser(id) { 
            $.ajax({
                url: "/api/user/"+id,
                type: "GET",
                contentType: "application/json",
                success: function (user) {
                 form.name.value=user.name;
                 form.age.value=user.age;
                 form.id.value=user.id;
                 }
            });
        }
        function deleteUser(id) { 

            $.ajax({
                url: "/api/user/"+id,
                type: "DELETE",
                contentType: "application/json",
                success: function (user) {
                    document.querySelector('tr[data-rowid="'+id+'"]').remove();
                }
            });

        }
        function adduser(data) {

            $.ajax({
                url:'/api/users',
                type:"POST",
                contentType: "application/json",
                data:JSON.stringify({name:data.name,age:data.age}),
                success: function (user) {
                    $("table tbody").append(row(user));
                }
            })
         }
        function editUser(id, data) {
            console.log(id,data)
            $.ajax({
                url: "/api/user/"+id,
                type: "PUT",
                contentType: "application/json",
                data:JSON.stringify({id,name:data.name,age:data.age}),
                success: function (user) {
                let node = document.createTextNode(row(user))
                 console.log(row(user));
                 $("tr[data-rowid='" + user.id + "']").replaceWith(row(user));
                 }
            });

         }
        var row = function (user) {
            return "<tr data-rowid='" + user.id + "'><td>" + user.id + "</td>" +
                "<td>" + user.name + "</td> <td>" + user.age + "</td>" +
                "<td><a class='editLink' data-id='" + user.id + "'>Изменить</a> | " +
                "<a class='removeLink' data-id='" + user.id + "'>Удалить</a></td></tr>";
        }

        document.querySelector('#reset').addEventListener('click', reserForm);
        document.body.addEventListener('click', function (event) {
            if (event.target.closest('.editLink')) {
                let id = event.target.dataset.id;
                getUser(id);
            }
            if (event.target.closest('.removeLink')) {
                let id = event.target.dataset.id;
                deleteUser(id);
            }
        });

        form.addEventListener('submit',(e)=>{

            e.preventDefault();
            let id=form.id.value;
            let name=form.name.value;
            let age = form.age.value;
            if(id==0)adduser({name,age});
            else editUser(id,{name,age});
            reserForm();
            form.id.value=0;
        })

        GetUsers();
    </script>
</body>

</html>